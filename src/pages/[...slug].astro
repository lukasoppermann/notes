---
import Layout from '../layouts/Layout.astro';
import { marked } from 'marked';
import { basename } from 'path';
import { readdirSync, readFileSync, statSync } from 'fs';
import { join } from 'path';

export async function getStaticPaths() {
  const notesDir = join(process.cwd(), 'src/data/notes');
  
  // Recursively get all markdown files
  function getAllMarkdownFiles(dir, baseDir = notesDir) {
    const files = [];
    const items = readdirSync(dir);
    
    for (const item of items) {
      const fullPath = join(dir, item);
      const stat = statSync(fullPath);
      
      if (stat.isDirectory()) {
        files.push(...getAllMarkdownFiles(fullPath, baseDir));
      } else if (item.endsWith('.md')) {
        // Get relative path from notes directory
        const relativePath = fullPath.replace(baseDir + '/', '').replace('.md', '');
        files.push({
          slug: relativePath,
          fullPath: fullPath,
        });
      }
    }
    
    return files;
  }
  
  const allFiles = getAllMarkdownFiles(notesDir);
  
  return allFiles.map(file => ({
    params: { slug: file.slug },
    props: { 
      filepath: file.fullPath
    },
  }));
}

const { filepath } = Astro.props;
const { slug } = Astro.params;

// Read the file content
const content = readFileSync(filepath, 'utf-8');

// Use marked to render markdown
const htmlContent = marked(content);

const title = basename(slug);
---

<Layout title={title}>
  <article set:html={htmlContent} />
</Layout>
