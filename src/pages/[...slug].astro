---
import Layout from '../layouts/Layout.astro';
import styles from './article.module.css';
import { basename } from 'path';
import { readdirSync, statSync } from 'fs';
import { join } from 'path';
import { processMarkdownFile } from '../utils/markdown';
import FavoriteButton from '../components/FavoriteButton/FavoriteButton.astro';

export async function getStaticPaths() {
  const notesDir = join(process.cwd(), 'src/data/notes');
  
  // Recursively get all markdown files
  function getAllMarkdownFiles(dir, baseDir = notesDir) {
    const files = [];
    const items = readdirSync(dir);
    
    for (const item of items) {
      const fullPath = join(dir, item);
      const stat = statSync(fullPath);
      
      if (stat.isDirectory()) {
        files.push(...getAllMarkdownFiles(fullPath, baseDir));
      } else if (item.endsWith('.md')) {
        // Get relative path from notes directory
        const relativePath = fullPath.replace(baseDir + '/', '').replace('.md', '');
        files.push({
          slug: relativePath,
          fullPath: fullPath,
        });
      }
    }
    return files;
  }
  
  const allFiles = getAllMarkdownFiles(notesDir);
  
  // Create paths - don't URL encode the slug, Astro handles that
  const paths = [];
  for (const file of allFiles) {
    // Just replace em-dashes with hyphens, but don't URL encode
    const normalizedSlug = file.slug.replace(/â€”/g, '-');
    paths.push({
      params: { slug: normalizedSlug },
      props: { 
        filepath: file.fullPath,
        originalSlug: file.slug
      },
    });
  }

  return paths;
}


const { filepath, originalSlug } = Astro.props;
const { slug } = Astro.params;

const getAfterLastSlash = (str) => {
  const idx = str.lastIndexOf('/');
  return idx === -1 ? str : str.slice(idx + 1);
}

// Process the markdown file
const { content: htmlContent, frontmatter } = await processMarkdownFile(filepath);
// Use original slug for title to preserve special characters
const title = frontmatter.title || basename(originalSlug || slug);

// Extract category (first part of the path) for favorites
const category = originalSlug.includes('/') ? originalSlug.split('/')[0] : 'Other';
const currentUrl = Astro.url.pathname;
---

<Layout title={title}>
  <article class={styles.article}>
    <div class={styles.articleHeader}>
      <h1>{title}</h1>
      <FavoriteButton url={currentUrl} title={title} category={category} />
    </div>
    <Fragment set:html={htmlContent} />
  </article>
</Layout>
