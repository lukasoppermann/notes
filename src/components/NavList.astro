---
const { items = [], currentPath = '' } = Astro.props;
console.log(currentPath)
console.log("items", items)
// Helper function to normalize URL for comparison
function normalizeUrl(url) {
  if (!url) return '';
  
  // Decode first if needed
  let normalized = url;
  try {
    normalized = decodeURIComponent(url);
  } catch {
    // If decoding fails, use as-is
  }
  
  // Add leading slash if not present
  if (!normalized.startsWith('/')) {
    normalized = '/' + normalized;
  }
  
  // Remove file extensions and index
  normalized = normalized
    .replace('.html', '')
    .replace('.md', '')
    .replace('/index', '')
    .replace(/\/+/g, '/')  // Replace multiple slashes with single slash
    .replace(/\/$/, '');   // Remove trailing slash for comparison
  
  // Replace em-dashes with hyphens for comparison (to match slug normalization)
  normalized = normalized.replace(/—/g, '-');
  
  return normalized;
}

// Helper function to create URL-friendly path
function encodeUrlPath(path) {
  if (!path) return '';
  // Replace em-dashes with regular hyphens and URL-encode the rest
  return path.split('/').map(segment => {
    // Replace em-dash with hyphen
    const normalized = segment.replace(/—/g, '-');
    // Then URL-encode
    return encodeURIComponent(normalized);
  }).join('/');
}

const normalizedCurrent = normalizeUrl(currentPath);
console.log(normalizedCurrent)
---

<ul>
  {items.map(item => {
    if (item.children) {
      // Check if this section should be open (has active child)
      const hasActiveChild = item.children.some(child => {
        const childUrl = normalizeUrl(child.url);
        if (normalizedCurrent === childUrl) return true;
        // Check grandchildren
        if (child.children) {
          return child.children.some(grandchild => {
            const grandchildUrl = normalizeUrl(grandchild.url);
            return normalizedCurrent === grandchildUrl;
          });
        }
        return false;
      });

      return (
        <li>
          <details open={hasActiveChild}>
            <summary>{item.title}</summary>
            <Astro.self items={item.children} currentPath={currentPath} />
          </details>
        </li>
      );
    } else {
      const itemUrl = normalizeUrl(item.url);
      const isActive = normalizedCurrent === itemUrl;
      
      if (item.title !== "index") {
        // Build URL with encoded path, ensuring proper leading/trailing slashes
        const encodedPath = encodeUrlPath(item.url);
        const href = `/${encodedPath}/`;
        
        return (
          <li>
            <a 
              href={href}
              class={isActive ? 'active' : ''}
            >
              {item.title}
            </a>
          </li>
        );
      }
    }
  })}
</ul>
